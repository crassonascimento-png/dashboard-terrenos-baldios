{% extends "base.html" %}
{% block content %}
<h3>Editar Terreno Baldio #{{ terreno.id }}</h3>
<h3>Detalhes do Terreno Baldio #{{ terreno.id }}</h3>

<form method="post" enctype="multipart/form-data">
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="bairro" class="form-label">Bairro</label>
      <input
        type="text"
        class="form-control"
        id="bairro"
        name="bairro"
        value="{{ terreno.bairro }}"
        required
      />
    </div>
    <div class="col-md-3">
      <label for="microarea" class="form-label">Microárea</label>
      <input
        type="text"
        class="form-control"
        id="microarea"
        name="microarea"
        value="{{ terreno.microarea or '' }}"
        placeholder="Ex: MA 01"
      />
    </div>
    <div class="col-md-3">
      <label for="endereco" class="form-label">Endereço aproximado</label>
      <input
        type="text"
        class="form-control"
        id="endereco"
        name="endereco"
        value="{{ terreno.endereco }}"
        required
      />
    </div>
    <div class="col-md-3">
      <label for="referencia" class="form-label">Ponto de referência</label>
      <input
        type="text"
        class="form-control"
        id="referencia"
        name="referencia"
        value="{{ terreno.referencia or '' }}"
      />
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-3">
      <label for="latitude" class="form-label">Latitude</label>
      <input
        type="text"
        class="form-control"
        id="latitude"
        name="latitude"
        value="{{ terreno.latitude or '' }}"
        placeholder="-10.9"
      />
    </div>
    <div class="col-md-3">
      <label for="longitude" class="form-label">Longitude</label>
      <input
        type="text"
        class="form-control"
        id="longitude"
        name="longitude"
        value="{{ terreno.longitude or '' }}"
        placeholder="-37.0"
      />
    </div>
    <div class="mb-3">
  <label class="form-label">Localização no mapa</label>
  <p class="text-muted mb-1">
    Clique no mapa para marcar o ponto do terreno. Você também pode arrastar o marcador.
  </p>

  <!-- Leaflet CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <div
    id="map-edit"
    style="height: 300px; border-radius: 8px; border: 1px solid #ccc;"
    class="mt-2"
  ></div>

  <script>
    // Pega os inputs
    const latInput = document.getElementById("latitude");
    const lngInput = document.getElementById("longitude");

    // Converte valores existentes (se houver)
    let lat = parseFloat(latInput.value);
    let lng = parseFloat(lngInput.value);

    // Centro padrão: Aracaju (aprox.)
    const defaultLat = -10.9472;
    const defaultLng = -37.0731;

    const hasCoords = !isNaN(lat) && !isNaN(lng);

    const startLat = hasCoords ? lat : defaultLat;
    const startLng = hasCoords ? lng : defaultLng;
    const startZoom = hasCoords ? 18 : 13;

    const map = L.map("map-edit").setView([startLat, startLng], startZoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    let marker = null;

    function atualizarInputs(pos) {
      latInput.value = pos.lat.toFixed(6);
      lngInput.value = pos.lng.toFixed(6);
    }

    // Se já tem coordenadas, coloca marcador
    if (hasCoords) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on("dragend", function (e) {
        const pos = e.target.getLatLng();
        atualizarInputs(pos);
      });
    }

    // Clique no mapa cria/atualiza marcador
    map.on("click", function (e) {
      const pos = e.latlng;

      if (marker) {
        marker.setLatLng(pos);
      } else {
        marker = L.marker(pos, { draggable: true }).addTo(map);
        marker.on("dragend", function (e2) {
          const pos2 = e2.target.getLatLng();
          atualizarInputs(pos2);
        });
      }

      atualizarInputs(pos);
    });
  </script>
</div>

    <div class="col-md-3 d-flex align-items-center">
      <div class="form-check mt-4">
        <input
          class="form-check-input"
          type="checkbox"
          id="tem_lixo"
          name="tem_lixo"
          {% if terreno.tem_lixo %}checked{% endif %}
        />
        <label class="form-check-label" for="tem_lixo">
          Há acúmulo de lixo?
        </label>
      </div>
    </div>
    <div class="col-md-3 d-flex align-items-center">
      <div class="form-check mt-4">
        <input
          class="form-check-input"
          type="checkbox"
          id="tem_agua_parada"
          name="tem_agua_parada"
          {% if terreno.tem_agua_parada %}checked{% endif %}
        />
        <label class="form-check-label" for="tem_agua_parada">
          Há água parada / criadouro?
        </label>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <label for="risco" class="form-label">Classificação de risco</label>
    <select class="form-select" id="risco" name="risco">
      {% for r in riscos_lista %}
      <option value="{{ r }}" {% if terreno.risco == r %}selected{% endif %}>
        {{ r }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="observacoes" class="form-label">Observações</label>
    <textarea
      class="form-control"
      id="observacoes"
      name="observacoes"
      rows="3"
    >{{ terreno.observacoes or '' }}</textarea>
  </div>

  <p class="text-muted">
    <strong>Nota:</strong> a situação (Pendente, Em limpeza, Limpo, Reincidente)
    deve ser atualizada na tela de detalhes, para manter o histórico de alterações
    corretamente registrado.
  </p>
{% if terreno.fotos %}
  <h5 class="mt-4">Fotos já cadastradas</h5>
  <div class="row mb-3">
    {% for foto in terreno.fotos %}
    <div class="col-md-3 col-sm-4 col-6 mb-3">
      <div class="card">
        <img
          src="{{ url_for('static', filename='uploads/' ~ foto.arquivo) }}"
          class="card-img-top"
          alt="Foto do terreno"
          style="max-height: 160px; object-fit: cover;"
        />
      </div>
    </div>
    {% endfor %}
  </div>
{% endif %}

<div class="mb-3">
  <label for="novas_fotos" class="form-label">Adicionar novas fotos do terreno</label>
  <input
    class="form-control"
    type="file"
    id="novas_fotos"
    name="novas_fotos"
    multiple
    accept="image/*"
  />
  <div class="form-text">
    Essas fotos serão adicionadas às existentes (não substituem as antigas).
  </div>
</div>

  <button type="submit" class="btn btn-success">Salvar alterações</button>
  <a href="{{ url_for('terreno_detalhe', terreno_id=terreno.id) }}" class="btn btn-secondary">
    Cancelar
  </a>
</form>
{% endblock %}
