{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Terrenos Baldios Cadastrados</h3>
  <a href="{{ url_for('novo_terreno') }}" class="btn btn-primary">Novo Terreno</a>
</div>
<form method="get" class="row g-2 mb-3">
  <div class="col-md-3">
    <label for="bairro" class="form-label">Bairro</label>
    <select class="form-select" id="bairro" name="bairro">
      <option value="">Todos</option>
      {% for b in bairros %}
      <option value="{{ b }}" {% if bairro_selecionado == b %}selected{% endif %}>
        {{ b }}
      </option>
      {% endfor %}
    </select>
  </div>

<div class="mb-3">
  <a
    href="{{ url_for('exportar', bairro=bairro_selecionado, risco=risco_selecionado, situacao=situacao_selecionada) }}"
    class="btn btn-outline-success"
  >
    Exportar CSV (Excel)
  </a>
</div>

  <div class="col-md-3">
    <label for="risco" class="form-label">Risco</label>
    <select class="form-select" id="risco" name="risco">
      <option value="">Todos</option>
      {% for r in riscos_lista %}
      <option value="{{ r }}" {% if risco_selecionado == r %}selected{% endif %}>
        {{ r }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label for="situacao" class="form-label">Situação</label>
    <select class="form-select" id="situacao" name="situacao">
      <option value="">Todas</option>
      {% for s in situacoes_lista %}
      <option value="{{ s }}" {% if situacao_selecionada == s %}selected{% endif %}>
        {{ s }}
      </option>
      {% endfor %}
    </select>
  </div>

{% if total_geral is not none %}
<div class="row mb-3">
  <div class="col-md-3 mb-2">
    <div class="card border-primary">
      <div class="card-body p-2">
        <small class="text-muted">Total de terrenos</small>
        <h4 class="mb-0">{{ total_geral }}</h4>
      </div>
    </div>
    </div>
  <div class="col-md-3 mb-2">
    <div class="card border-warning">
      <div class="card-body p-2">
        <small class="text-muted">Pendente</small>
        <h5 class="mb-0">{{ totais_situacao.get("Pendente", 0) }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-2">
    <div class="card border-info">
      <div class="card-body p-2">
        <small class="text-muted">Em limpeza</small>
        <h5 class="mb-0">{{ totais_situacao.get("Em limpeza", 0) }}</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-2">
    <div class="card border-success">
      <div class="card-body p-2">
        <small class="text-muted">Limpo</small>
        <h5 class="mb-0">{{ totais_situacao.get("Limpo", 0) }}</h5>
      </div>
    </div>
  </div>
</div>
{% endif %}


  <div class="col-md-3 d-flex align-items-end">
    <button type="submit" class="btn btn-success me-2">Filtrar</button>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Limpar</a>
  </div>

<div class="row mb-3">
  <div class="col-md-4">
    <label for="modo-cor" class="form-label">Colorir marcadores por:</label>
    <select id="modo-cor" class="form-select">
      <option value="risco">Risco (Baixo / Médio / Alto)</option>
      <option value="situacao">Situação (Pendente / Em limpeza / Limpo / Reincidente)</option>
    </select>
  </div>
</div>

<div
  id="map-dashboard"
  style="height: 400px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px;"
></div>

</form>


{% if terrenos %}
  <table class="table table-striped table-bordered">
    <thead>
  <tr>
    <th>ID</th>
    <th>Bairro</th>
    <th>Endereço</th>
    <th>Lixo</th>
    <th>Água parada</th>
    <th>Risco</th>
    <th>Criado por</th>
    <th>Fotos</th>
    <th>Ações</th>
  </tr>
</thead>
<tbody>
  {% for t in terrenos %}
  <tr>
    <td>{{ t.id }}</td>
    <td>{{ t.bairro }}</td>
    <td>{{ t.microarea or "-" }}</td>
    <td>{{ t.endereco }}</td>
    <td>{{ "Sim" if t.tem_lixo else "Não" }}</td>
    <td>{{ "Sim" if t.tem_agua_parada else "Não" }}</td>
    <td>{{ t.risco }}</td>
    <td>{{ t.situacao }}</td>
    <td>{{ t.criado_por.nome if t.criado_por else "-" }}</td>
    <td>
      {% if t.fotos %}
        <div>{{ t.fotos|length }} foto(s)</div>
        <img
          src="{{ url_for('static', filename='uploads/' ~ t.fotos[0].arquivo) }}"
          alt="Foto do terreno"
          style="max-width: 80px; max-height: 80px; margin-top: 4px;"
        />
      {% else %}
        -
      {% endif %}
    </td>
    <td>
      <a
        href="{{ url_for('terreno_detalhe', terreno_id=t.id) }}"
        class="btn btn-sm btn-outline-primary mb-1"
      >
        Ver
      </a>
    </td>
  </tr>
  {% endfor %}
</tbody>
  </table>
{% else %}
  <div class="alert alert-info">
    Nenhum terreno baldio cadastrado ainda. Clique em <strong>Novo Terreno</strong> para inserir o primeiro.
  </div>
  {% endif %}
 <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // Monta array JS com os terrenos que têm coordenadas válidas
  const terrenosData = [
    {% for t in terrenos %}
      {% if t.latitude and t.longitude %}
      {
        id: {{ t.id }},
        bairro: "{{ t.bairro|e }}",
        microarea: "{{ (t.microarea or '')|e }}",
        risco: "{{ t.risco }}",
        situacao: "{{ t.situacao }}",
        lat: "{{ t.latitude }}",
        lng: "{{ t.longitude }}",
        urlDetalhe: "{{ url_for('terreno_detalhe', terreno_id=t.id) }}"
      },
      {% endif %}
    {% endfor %}
  ];

  const defaultLat = -10.9472;  // Aproximado Aracaju
  const defaultLng = -37.0731;

  const map = L.map("map-dashboard").setView([defaultLat, defaultLng], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  let markers = [];

  function corPorRisco(risco) {
    switch (risco) {
      case "Alto":
        return "#e53935"; // vermelho
      case "Médio":
        return "#fb8c00"; // laranja
      case "Baixo":
      default:
        return "#43a047"; // verde
    }
  }

  function corPorSituacao(sit) {
    switch (sit) {
      case "Pendente":
        return "#fdd835"; // amarelo
      case "Em limpeza":
        return "#1e88e5"; // azul
      case "Limpo":
        return "#43a047"; // verde
      case "Reincidente":
        return "#e53935"; // vermelho
      default:
        return "#757575"; // cinza
    }
  }

  function desenharMarcadores(modo = "risco") {
    // Remove marcadores antigos
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const bounds = [];

    terrenosData.forEach(t => {
      const lat = parseFloat(t.lat);
      const lng = parseFloat(t.lng);
      if (isNaN(lat) || isNaN(lng)) {
        return;
      }

      const color = modo === "situacao"
        ? corPorSituacao(t.situacao)
        : corPorRisco(t.risco);

      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: color,
        fillColor: color,
        fillOpacity: 0.85
      }).addTo(map);

      const popupHtml = `
        <div>
          <strong>Terreno #${t.id}</strong><br />
          Bairro: ${t.bairro}<br />
          Microárea: ${t.microarea || "-"}<br />
          Risco: ${t.risco}<br />
          Situação: ${t.situacao}<br />
          <a href="${t.urlDetalhe}">Ver detalhes</a>
        </div>
      `;

      marker.bindPopup(popupHtml);
      markers.push(marker);
      bounds.push([lat, lng]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [20, 20] });
    } else {
      map.setView([defaultLat, defaultLng], 12);
    }
  }

  // Desenha inicialmente com cor por risco
  desenharMarcadores("risco");

  // Muda cores quando trocar o seletor
  const modoCorSelect = document.getElementById("modo-cor");
  modoCorSelect.addEventListener("change", function () {
    const modo = this.value === "situacao" ? "situacao" : "risco";
    desenharMarcadores(modo);
  });
</script>
 
{% endblock %}