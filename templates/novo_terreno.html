{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Novo Terreno Baldio</h3>
<form method="post" enctype="multipart/form-data">
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="bairro" class="form-label">Bairro</label>
      <input type="text" class="form-control" id="bairro" name="bairro" required />
    </div>
    <div class="col-md-3">
      <label for="microarea" class="form-label">Microárea</label>
      <input
        type="text"
        class="form-control"
        id="microarea"
        name="microarea"
        placeholder="Ex: MA 01"
      />
    </div>
    <div class="col-md-3">
      <label for="endereco" class="form-label">Endereço aproximado</label>
      <input type="text" class="form-control" id="endereco" name="endereco" required />
    </div>
    <div class="col-md-3">
      <label for="latitude" class="form-label">Latitude</label>
      <input
        type="text"
        class="form-control"
        id="latitude"
        name="latitude"
        placeholder="-10.9"
      />
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="longitude" class="form-label">Longitude</label>
      <input
        type="text"
        class="form-control"
        id="longitude"
        name="longitude"
        placeholder="-37.0"
      />
    </div>
    <div class="mb-3">
  <label class="form-label">Localização no mapa</label>
  <p class="text-muted mb-1">
    Clique no mapa para marcar o ponto do terreno. Você também pode arrastar o marcador.
  </p>

  <!-- Leaflet CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <div
    id="map-novo"
    style="height: 300px; border-radius: 8px; border: 1px solid #ccc;"
    class="mt-2"
  ></div>

  <script>
    const latInputNovo = document.getElementById("latitude");
    const lngInputNovo = document.getElementById("longitude");

    const defaultLatNovo = -10.9472;
    const defaultLngNovo = -37.0731;

    const mapNovo = L.map("map-novo").setView([defaultLatNovo, defaultLngNovo], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(mapNovo);

    let markerNovo = null;

    function atualizarInputsNovo(pos) {
      latInputNovo.value = pos.lat.toFixed(6);
      lngInputNovo.value = pos.lng.toFixed(6);
    }

    mapNovo.on("click", function (e) {
      const pos = e.latlng;

      if (markerNovo) {
        markerNovo.setLatLng(pos);
      } else {
        markerNovo = L.marker(pos, { draggable: true }).addTo(mapNovo);
        markerNovo.on("dragend", function (e2) {
          const pos2 = e2.target.getLatLng();
          atualizarInputsNovo(pos2);
        });
      }

      atualizarInputsNovo(pos);
    });
  </script>
</div>

  </div>

  <div class="mb-3">
    <label for="referencia" class="form-label">Ponto de referência</label>
    <input type="text" class="form-control" id="referencia" name="referencia" />
  </div>

  <div class="form-check mb-2">
    <input
      class="form-check-input"
      type="checkbox"
      id="tem_lixo"
      name="tem_lixo"
    />
    <label class="form-check-label" for="tem_lixo">Há acúmulo de lixo?</label>
  </div>

  <div class="form-check mb-3">
    <input
      class="form-check-input"
      type="checkbox"
      id="tem_agua_parada"
      name="tem_agua_parada"
    />
    <label class="form-check-label" for="tem_agua_parada"
      >Há água parada / possível criadouro?</label
    >
  </div>

    <div class="mb-3">
    <label for="risco" class="form-label">Classificação de risco</label>
    <select class="form-select" id="risco" name="risco">
      <option value="Baixo">Baixo</option>
      <option value="Médio">Médio</option>
      <option value="Alto">Alto</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="situacao" class="form-label">Situação</label>
    <select class="form-select" id="situacao" name="situacao">
      {% for s in situacoes_lista %}
      <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
  </div>


  <div class="mb-3">
    <label for="observacoes" class="form-label">Observações</label>
    <textarea
      class="form-control"
      id="observacoes"
      name="observacoes"
      rows="3"
    ></textarea>
  </div>
  <div class="mb-3">
    <label for="fotos" class="form-label">Fotos do terreno (até 5)</label>
    <input
      class="form-control"
      type="file"
      id="fotos"
      name="fotos"
      multiple
      accept="image/*"
      capture="environment"
    />
    <div class="form-text">
      Você pode selecionar várias fotos segurando Ctrl (ou Shift).
    </div>
  </div>

  <button type="submit" class="btn btn-success">Salvar</button>
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
</form>
{% endblock %}